"use strict";var d=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var S=(e,n)=>{for(var l in n)d(e,l,{get:n[l],enumerable:!0})},C=(e,n,l,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of E(n))!N.call(e,s)&&s!==l&&d(e,s,{get:()=>n[s],enumerable:!(t=T(n,s))||t.enumerable});return e};var b=e=>C(d({},"__esModule",{value:!0}),e);var x={};S(x,{handler:()=>w});module.exports=b(x);var g=require("@aws-sdk/client-dynamodb"),p=require("@aws-sdk/lib-dynamodb"),R=new g.DynamoDBClient({region:"ap-south-1"}),c=p.DynamoDBDocumentClient.from(R),m=process.env.DEADLINES_TABLE,w=async e=>{let n=Date.now();console.log("Calculate deadlines event:",JSON.stringify(e,null,2));let l;try{l=JSON.parse(e.body||"{}")}catch{return{statusCode:400,headers:{"Content-Type":"application/json"},body:JSON.stringify({error:{code:"INVALID_REQUEST",message:"Invalid JSON in request body"}})}}let t=l.entity;if(!t||!t.type||!t.state)return{statusCode:400,headers:{"Content-Type":"application/json"},body:JSON.stringify({error:{code:"MISSING_PARAMETERS",message:"entity.type and entity.state are required"}})};try{let s=[],h=new Date().getFullYear().toString(),D=(await c.send(new p.QueryCommand({TableName:m,KeyConditionExpression:"PK = :pk AND begins_with(SK, :prefix)",ExpressionAttributeValues:{":pk":"AU#FEDERAL",":prefix":"DEADLINE#"}}))).Items||[],f=(await c.send(new p.QueryCommand({TableName:m,KeyConditionExpression:"PK = :pk AND begins_with(SK, :prefix)",ExpressionAttributeValues:{":pk":`AU#${t.state}`,":prefix":"DEADLINE#"}}))).Items||[],A=[...D,...f];for(let a of A){let r=a.data||{},o=!1,i="";if(r.type==="BAS"&&t.gstRegistered&&(o=!0,i="GST registered entity"),r.type==="PAYG"&&t.employees&&t.employees>0&&(o=!0,i="Has employees"),r.type==="SUPER"&&t.employees&&t.employees>0&&(o=!0,i="Has employees"),r.type==="PAYROLL_TAX"){let u=I(t.state);t.turnover&&t.turnover>=u&&(o=!0,i=`Turnover exceeds ${u.toLocaleString()} threshold`)}r.type==="INCOME_TAX"&&(o=!0,i="Applies to all entities"),r.type==="COMPANY_TAX"&&t.type==="company"&&(o=!0,i="Company entity"),o&&s.push({id:r.id||`${a.PK}-${a.SK}`.toLowerCase().replace(/[#]/g,"-"),...r,applicableReason:i,priority:P(r)})}s.sort((a,r)=>{let o=new Date(a.dueDate||a.dates?.dueDate).getTime(),i=new Date(r.dueDate||r.dates?.dueDate).getTime();return o-i});let y=Date.now()-n;return{statusCode:200,headers:{"Content-Type":"application/json","X-Response-Time":`${y}ms`},body:JSON.stringify({meta:{code:200,executionTimeMs:y,count:s.length},response:{entity:t,deadlines:s,summary:{total:s.length,highPriority:s.filter(a=>a.priority==="high").length,upcoming30Days:s.filter(a=>{let o=(new Date(a.dueDate||a.dates?.dueDate).getTime()-Date.now())/(1e3*60*60*24);return o>=0&&o<=30}).length}}})}}catch(s){return console.error("Error calculating deadlines:",s),{statusCode:500,headers:{"Content-Type":"application/json","X-Response-Time":`${Date.now()-n}ms`},body:JSON.stringify({error:{code:"INTERNAL_ERROR",message:"Failed to calculate deadlines",requestId:e.requestContext.requestId}})}}};function I(e){return{NSW:12e5,VIC:7e5,QLD:13e5,SA:15e5,WA:1e6,TAS:125e4,NT:15e5,ACT:2e6}[e]||12e5}function P(e){return e.penalties&&e.penalties.lateFee>500||e.type==="BAS"||e.type==="PAYG"||e.type==="SUPER"?"high":e.type==="INCOME_TAX"||e.type==="COMPANY_TAX"?"medium":"low"}0&&(module.exports={handler});
