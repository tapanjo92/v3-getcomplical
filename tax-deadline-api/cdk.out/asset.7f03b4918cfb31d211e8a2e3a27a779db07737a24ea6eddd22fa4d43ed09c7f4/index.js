"use strict";var E=Object.create;var h=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var $=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var k=(t,e)=>{for(var n in e)h(t,n,{get:e[n],enumerable:!0})},D=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let u of P(e))!N.call(t,u)&&u!==n&&h(t,u,{get:()=>e[u],enumerable:!(r=C(e,u))||r.enumerable});return t};var q=(t,e,n)=>(n=t!=null?E($(t)):{},D(e||!t||!t.__esModule?h(n,"default",{value:t,enumerable:!0}):n,t)),x=t=>D(h({},"__esModule",{value:!0}),t);var G={};k(G,{handler:()=>L});module.exports=x(G);var O=require("@aws-sdk/client-dynamodb"),m=require("@aws-sdk/lib-dynamodb"),T=q(require("ioredis")),U=new O.DynamoDBClient({region:"ap-south-1"}),A=m.DynamoDBDocumentClient.from(U),K=process.env.USAGE_TABLE,M=process.env.REDIS_ENDPOINT,_=parseInt(process.env.REDIS_PORT||"6379"),R=null;function j(){return R||(R=new T.default({host:M,port:_,retryStrategy:t=>Math.min(t*50,2e3)})),R}var L=async t=>{console.log("Get usage event:",JSON.stringify(t,null,2));let e=t.requestContext.authorizer?.customerId||"unknown",n=parseInt(t.requestContext.authorizer?.monthlyLimit||"-1"),r=t.queryStringParameters?.period||"today",u=t.queryStringParameters?.detailed==="true";try{let i=j(),c=new Date,l=c.toISOString().slice(0,7),y=c.toISOString().slice(0,10),o={customerId:e,period:r,timestamp:c.toISOString()};switch(r){case"today":o=await B(i,e,y);break;case"month":o=await H(i,A,e,l);break;case"hour":o=await v(i,e);break;default:return{statusCode:400,headers:{"Content-Type":"application/json"},body:JSON.stringify({error:{code:"INVALID_PERIOD",message:"Period must be one of: today, month, hour"}})}}return o.limits={monthly:n,used:o.monthTotal||0,remaining:n>0?Math.max(0,n-(o.monthTotal||0)):-1,percentUsed:n>0?Math.round((o.monthTotal||0)/n*100):0},{statusCode:200,headers:{"Content-Type":"application/json","Cache-Control":"private, max-age=60"},body:JSON.stringify({meta:{code:200},response:o})}}catch(i){return console.error("Error getting usage:",i),{statusCode:500,headers:{"Content-Type":"application/json"},body:JSON.stringify({error:{code:"INTERNAL_ERROR",message:"Failed to retrieve usage data"}})}}};async function B(t,e,n){let r=`usage:${e}:${n}:*`,u=await t.keys(r),i=0,c=[],l={};for(let s of u){let g=s.split(":").pop(),f=await t.hgetall(s),w=0;for(let[S,b]of Object.entries(f)){let I=parseInt(b);w+=I,l[S]=(l[S]||0)+I}i+=w,c.push({hour:parseInt(g),requests:w})}let y=n.slice(0,7),o=await t.hget(`usage:monthly:${e}:${y}`,"total"),d=[],a=await t.keys(`latency:${e}:${n}:*`);for(let s of a){let g=await t.lrange(s,0,-1);d.push(...g.map(f=>parseInt(f)))}let p=d.length>0?Math.round(d.reduce((s,g)=>s+g,0)/d.length):0;return{customerId:e,period:"today",date:n,totalRequests:i,monthTotal:parseInt(o||"0"),avgLatency:p,hourlyData:c.sort((s,g)=>s.hour-g.hour),apiKeyBreakdown:Object.entries(l).map(([s,g])=>({apiKeyId:s,requests:g}))}}async function H(t,e,n,r){let u=await t.hget(`usage:monthly:${n}:${r}`,"total"),i=await e.send(new m.QueryCommand({TableName:K,KeyConditionExpression:"PK = :pk AND begins_with(SK, :prefix)",ExpressionAttributeValues:{":pk":`USAGE#${n}`,":prefix":`HOUR#${r}`}})),c={},l={},y=0,o=0;for(let a of i.Items||[]){let p=a.dateHour.split(":")[0];c[p]=(c[p]||0)+a.requests,o+=a.requests,y+=a.errors||0;for(let s of a.topEndpoints||[])l[s.endpoint]=(l[s.endpoint]||0)+s.count}let d=o>0?(y/o*100).toFixed(2):"0";return{customerId:n,period:"month",month:r,monthTotal:parseInt(u||"0"),totalRequests:o,totalErrors:y,errorRate:parseFloat(d),dailyBreakdown:Object.entries(c).map(([a,p])=>({date:a,requests:p})).sort((a,p)=>a.date.localeCompare(p.date)),topEndpoints:Object.entries(l).sort((a,p)=>p[1]-a[1]).slice(0,10).map(([a,p])=>({endpoint:a,count:p}))}}async function v(t,e){let n=new Date,r=`${n.toISOString().slice(0,10)}:${n.getUTCHours().toString().padStart(2,"0")}`,u=await t.hgetall(`usage:${e}:${r}`),i=0,c=[];for(let[o,d]of Object.entries(u)){let a=parseInt(d);i+=a,c.push({apiKeyId:o,requests:a})}let l=await t.lrange(`latency:${e}:${r}`,0,-1),y=l.length>0?Math.round(l.map(o=>parseInt(o)).reduce((o,d)=>o+d,0)/l.length):0;return{customerId:e,period:"hour",hour:r,requests:i,avgLatency:y,apiKeys:c,lastUpdated:n.toISOString()}}0&&(module.exports={handler});
