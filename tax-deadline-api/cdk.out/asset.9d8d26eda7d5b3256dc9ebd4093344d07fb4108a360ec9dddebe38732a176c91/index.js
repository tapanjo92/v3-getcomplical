"use strict";var f=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var q=(e,a)=>{for(var o in a)f(e,o,{get:a[o],enumerable:!0})},K=(e,a,o,i)=>{if(a&&typeof a=="object"||typeof a=="function")for(let r of N(a))!x.call(e,r)&&r!==o&&f(e,r,{get:()=>a[r],enumerable:!(i=P(a,r))||i.enumerable});return e};var R=e=>K(f({},"__esModule",{value:!0}),e);var L={};q(L,{handler:()=>G});module.exports=R(L);var A=require("@aws-sdk/client-dynamodb"),g=require("@aws-sdk/lib-dynamodb"),u=require("@aws-sdk/client-kinesis"),k=new A.DynamoDBClient({region:"ap-south-1"}),O=g.DynamoDBDocumentClient.from(k),T=new u.KinesisClient({region:"ap-south-1"}),B=process.env.DEADLINES_TABLE,h=process.env.USAGE_STREAM||"tax-deadline-usage-dev",G=async e=>{let a=Date.now();console.log("Get deadlines event:",JSON.stringify(e,null,2));let o=e.queryStringParameters?.country?.toUpperCase()||"AU",i=e.queryStringParameters?.state?.toUpperCase()||"FEDERAL",r=e.queryStringParameters?.year||new Date().getFullYear().toString(),d=e.queryStringParameters?.type?.toUpperCase(),m=e.queryStringParameters?.upcoming,p=e.requestContext.authorizer?.customerId||"unknown",w=e.requestContext.authorizer?.apiKeyId||"unknown";try{let c=`${o}#${i}`,l={TableName:B,KeyConditionExpression:"PK = :pk AND begins_with(SK, :prefix)",ExpressionAttributeValues:{":pk":c,":prefix":"DEADLINE#"}},s=(await O.send(new g.QueryCommand(l))).Items||[];if(s=s.filter(t=>{let n=t.data?.dueDate||t.data?.dates?.dueDate;return n&&n.startsWith(r)}),d&&(s=s.filter(t=>t.data?.type===d||t.SK.includes(d))),m){let t=parseInt(m),n=new Date;n.setDate(n.getDate()+t),s=s.filter(y=>{let D=new Date(y.data?.dueDate||y.data?.dates?.dueDate);return D>=new Date&&D<=n})}s.sort((t,n)=>{let y=new Date(t.data?.dueDate||t.data?.dates?.dueDate).getTime(),D=new Date(n.data?.dueDate||n.data?.dates?.dueDate).getTime();return y-D});let C=s.map(t=>({id:t.data?.id||`${t.PK}-${t.SK}`.toLowerCase().replace(/[#]/g,"-"),...t.data})),S=Date.now()-a,I={customerId:p,apiKeyId:w,endpoint:"/v1/deadlines",method:"GET",statusCode:200,responseTime:S,timestamp:new Date().toISOString(),parameters:{country:o,state:i,year:r,type:d,upcoming:m}};try{await T.send(new u.PutRecordCommand({StreamName:h,Data:Buffer.from(JSON.stringify(I)),PartitionKey:p}))}catch(t){console.error("Failed to track usage:",t)}return{statusCode:200,headers:{"Content-Type":"application/json","Cache-Control":"public, max-age=300","X-Response-Time":`${S}ms`},body:JSON.stringify({meta:{code:200,executionTimeMs:S,cacheStatus:"MISS",count:C.length},response:{deadlines:C,query:{country:o,state:i,year:r,type:d,upcoming:m}}})}}catch(c){console.error("Error getting deadlines:",c);let l=Date.now()-a;try{await T.send(new u.PutRecordCommand({StreamName:h,Data:Buffer.from(JSON.stringify({customerId:p,apiKeyId:w,endpoint:"/v1/deadlines",method:"GET",statusCode:500,responseTime:l,timestamp:new Date().toISOString(),error:c instanceof Error?c.message:"Unknown error"})),PartitionKey:p}))}catch(E){console.error("Failed to track error:",E)}return{statusCode:500,headers:{"Content-Type":"application/json","X-Response-Time":`${l}ms`},body:JSON.stringify({error:{code:"INTERNAL_ERROR",message:"Failed to retrieve deadlines",requestId:e.requestContext.requestId}})}}};0&&(module.exports={handler});
