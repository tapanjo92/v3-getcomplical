"use strict";var w=Object.create;var l=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var K=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty;var M=(t,o)=>{for(var r in o)l(t,r,{get:o[r],enumerable:!0})},S=(t,o,r,e)=>{if(o&&typeof o=="object"||typeof o=="function")for(let s of T(o))!O.call(t,s)&&s!==r&&l(t,s,{get:()=>o[s],enumerable:!(e=E(o,s))||e.enumerable});return t};var P=(t,o,r)=>(r=t!=null?w(K(t)):{},S(o||!t||!t.__esModule?l(r,"default",{value:t,enumerable:!0}):r,t)),q=t=>S(l({},"__esModule",{value:!0}),t);var v={};M(v,{handler:()=>N});module.exports=q(v);var R=require("@aws-sdk/client-dynamodb"),g=require("@aws-sdk/lib-dynamodb"),I=P(require("ioredis")),B=new R.DynamoDBClient({region:"ap-south-1"}),C=g.DynamoDBDocumentClient.from(B),H=process.env.USAGE_TABLE,x=process.env.REDIS_ENDPOINT,A=parseInt(process.env.REDIS_PORT||"6379"),$=null;function b(){return $||($=new I.default({host:x,port:A,retryStrategy:t=>Math.min(t*50,2e3)})),$}var N=async t=>{console.log(`Processing ${t.Records.length} usage records`);let o=b(),r=new Map;try{for(let e of t.Records)try{let s=JSON.parse(Buffer.from(e.kinesis.data,"base64").toString("utf-8"));await U(s,o,r)}catch(s){console.error("Error processing record:",s,e)}r.size>0&&await _(r)}catch(e){throw console.error("Error in usage processor:",e),e}};async function U(t,o,r){let{customerId:e,apiKeyId:s,endpoint:m,method:u,statusCode:a,responseTime:c,timestamp:D}=t,d=new Date(D),i=`${d.toISOString().slice(0,10)}:${d.getUTCHours().toString().padStart(2,"0")}`,f=d.toISOString().slice(0,7),n=o.pipeline();n.hincrby(`usage:${e}:${i}`,s,1),n.expire(`usage:${e}:${i}`,86400),n.hincrby(`usage:daily:${e}:${d.toISOString().slice(0,10)}`,"total",1),n.expire(`usage:daily:${e}:${d.toISOString().slice(0,10)}`,172800),n.hincrby(`usage:monthly:${e}:${f}`,"total",1),n.expire(`usage:monthly:${e}:${f}`,2592e3),n.lpush(`latency:${e}:${i}`,c),n.ltrim(`latency:${e}:${i}`,0,999),n.expire(`latency:${e}:${i}`,86400),a>=400&&(n.hincrby(`errors:${e}:${i}`,m,1),n.expire(`errors:${e}:${i}`,86400)),await n.exec();let y=`${e}#${i}`;r.has(y)||r.set(y,{customerId:e,dateHour:i,requests:0,errors:0,totalResponseTime:0,endpoints:new Map,apiKeys:new Set});let p=r.get(y);p.requests++,a>=400&&p.errors++,p.totalResponseTime+=c,p.apiKeys.add(s);let h=`${u} ${m}`;p.endpoints.set(h,(p.endpoints.get(h)||0)+1)}async function _(t){let o=[];for(let[e,s]of t){let m=Math.floor(Date.now()/1e3)+7776e3,u={PK:`USAGE#${s.customerId}`,SK:`HOUR#${s.dateHour}`,customerId:s.customerId,dateHour:s.dateHour,requests:s.requests,errors:s.errors,avgResponseTime:Math.round(s.totalResponseTime/s.requests),uniqueApiKeys:s.apiKeys.size,topEndpoints:Array.from(s.endpoints.entries()).sort((a,c)=>c[1]-a[1]).slice(0,10).map(([a,c])=>({endpoint:a,count:c})),ttl:m};o.push({PutRequest:{Item:u}})}let r=[];for(let e=0;e<o.length;e+=25)r.push(o.slice(e,e+25));for(let e of r)await C.send(new g.BatchWriteCommand({RequestItems:{[H]:e}}));console.log(`Wrote ${o.length} usage aggregates to DynamoDB`)}0&&(module.exports={handler});
