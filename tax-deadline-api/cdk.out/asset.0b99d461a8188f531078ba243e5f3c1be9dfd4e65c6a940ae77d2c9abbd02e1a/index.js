"use strict";var m=Object.create;var i=Object.defineProperty;var l=Object.getOwnPropertyDescriptor;var d=Object.getOwnPropertyNames;var p=Object.getPrototypeOf,y=Object.prototype.hasOwnProperty;var A=(e,t)=>{for(var r in t)i(e,r,{get:t[r],enumerable:!0})},s=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of d(t))!y.call(e,o)&&o!==r&&i(e,o,{get:()=>t[o],enumerable:!(n=l(t,o))||n.enumerable});return e};var w=(e,t,r)=>(r=e!=null?m(p(e)):{},s(t||!e||!e.__esModule?i(r,"default",{value:e,enumerable:!0}):r,e)),I=e=>s(i({},"__esModule",{value:!0}),e);var D={};A(D,{handler:()=>x});module.exports=I(D);var c=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb"),h=w(require("crypto")),f=new c.DynamoDBClient({region:"ap-south-1"}),z=a.DynamoDBDocumentClient.from(f),E=process.env.API_KEYS_TABLE,x=async e=>{console.log("Authorizer event:",JSON.stringify(e,null,2));let t=e.headers?.["x-api-key"]||e.headers?.["X-API-Key"]||e.authorizationToken;if(!t||!t.startsWith("td_"))throw new Error("Unauthorized");try{let r=h.createHash("sha256").update(t).digest("hex"),n=await z.send(new a.QueryCommand({TableName:E,IndexName:"KeyLookupIndex",KeyConditionExpression:"apiKeyHash = :hash",ExpressionAttributeValues:{":hash":r},Limit:1}));if(!n.Items||n.Items.length===0)throw new Error("Unauthorized");let o=n.Items[0];if(o.status!=="active")throw new Error("Unauthorized");if(o.expiresAt&&new Date(o.expiresAt)<new Date)throw new Error("Unauthorized");let u={principalId:o.customerId,policyDocument:{Version:"2012-10-17",Statement:[{Action:"execute-api:Invoke",Effect:"Allow",Resource:e.methodArn.replace(/\/[^\/]+\/[^\/]+$/,"/*/*")}]},context:{customerId:o.customerId,tier:o.tier,monthlyLimit:String(o.monthlyLimit||-1),apiKeyId:o.SK.split("#")[1]}};return console.log("Authorization successful for customer:",o.customerId),u}catch(r){throw console.error("Authorization failed:",r),new Error("Unauthorized")}};0&&(module.exports={handler});
