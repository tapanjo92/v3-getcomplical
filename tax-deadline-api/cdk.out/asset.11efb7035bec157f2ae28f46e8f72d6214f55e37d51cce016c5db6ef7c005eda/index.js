"use strict";var g=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var D=(r,e)=>{for(var t in e)g(r,t,{get:e[t],enumerable:!0})},K=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of S(e))!w.call(r,o)&&o!==t&&g(r,o,{get:()=>e[o],enumerable:!(s=h(e,o))||s.enumerable});return r};var R=r=>K(g({},"__esModule",{value:!0}),r);var I={};D(I,{handler:()=>B});module.exports=R(I);var y=require("@aws-sdk/client-dynamodb"),c=require("@aws-sdk/lib-dynamodb"),$=new y.DynamoDBClient({region:"ap-south-1"}),T=c.DynamoDBDocumentClient.from($),q=process.env.USAGE_TABLE,B=async r=>{console.log(`Processing ${r.Records.length} usage records`);let e=new Map;try{for(let t of r.Records)try{let s=JSON.parse(Buffer.from(t.kinesis.data,"base64").toString("utf-8"));E(s,e)}catch(s){console.error("Error processing record:",s,t)}e.size>0&&await H(e)}catch(t){throw console.error("Error in usage processor:",t),t}};function E(r,e){let{customerId:t,apiKeyId:s,endpoint:o,method:d,statusCode:p,responseTime:a,timestamp:i}=r,u=new Date(i),l=`${u.toISOString().slice(0,10)}:${u.getUTCHours().toString().padStart(2,"0")}`,m=`${t}#${l}`;e.has(m)||e.set(m,{customerId:t,dateHour:l,requests:0,errors:0,totalResponseTime:0,endpoints:new Map,apiKeys:new Set});let n=e.get(m);n.requests++,p>=400&&n.errors++,n.totalResponseTime+=a,n.apiKeys.add(s);let f=`${d} ${o}`;n.endpoints.set(f,(n.endpoints.get(f)||0)+1)}async function H(r){let e=[];for(let[s,o]of r){let d=Math.floor(Date.now()/1e3)+7776e3,p={PK:`USAGE#${o.customerId}`,SK:`HOUR#${o.dateHour}`,customerId:o.customerId,dateHour:o.dateHour,requests:o.requests,errors:o.errors,avgResponseTime:Math.round(o.totalResponseTime/o.requests),uniqueApiKeys:o.apiKeys.size,topEndpoints:Array.from(o.endpoints.entries()).sort((a,i)=>i[1]-a[1]).slice(0,10).map(([a,i])=>({endpoint:a,count:i})),ttl:d};e.push({PutRequest:{Item:p}})}let t=[];for(let s=0;s<e.length;s+=25)t.push(e.slice(s,s+25));for(let s of t)await T.send(new c.BatchWriteCommand({RequestItems:{[q]:s}}));console.log(`Wrote ${e.length} usage aggregates to DynamoDB`)}0&&(module.exports={handler});
